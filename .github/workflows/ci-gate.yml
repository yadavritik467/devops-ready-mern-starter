name: CI Gate

on:
  workflow_run:
    workflows:
      - "Frontend CI + Docker"
      - "Backend CI + Docker"
    types:
      - completed

permissions:
  contents: read
  checks: read

jobs:
  gate:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure this is a PR
        if: ${{ github.event.workflow_run.pull_requests == '' }}
        run: |
          echo "Not triggered by a PR. Skipping."
          exit 0

      - name: Evaluate CI results
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.workflow_run.head_sha;

            const checks = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
            });

            const frontend = checks.data.check_runs.find(c =>
              c.name.includes("Frontend CI + Docker")
            );

            const backend = checks.data.check_runs.find(c =>
              c.name.includes("Backend CI + Docker")
            );

            if (frontend && frontend.conclusion !== "success") {
              core.setFailed("Frontend CI failed");
            }

            if (backend && backend.conclusion !== "success") {
              core.setFailed("Backend CI failed");
            }

            console.log("CI Gate passed");
