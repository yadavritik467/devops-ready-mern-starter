name: CI Gate

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: read

jobs:
  gate:
    runs-on: ubuntu-latest

    steps:
      - name: Decide CI status
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.pull_request.head.sha;

            const checks = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
            });

            const frontend = checks.data.check_runs.find(c =>
              c.name.includes("Frontend CI")
            );
            const backend = checks.data.check_runs.find(c =>
              c.name.includes("Backend CI")
            );

            if (frontend && frontend.conclusion !== "success") {
              core.setFailed("Frontend CI failed");
            }

            if (backend && backend.conclusion !== "success") {
              core.setFailed("Backend CI failed");
            }

            console.log("CI Gate passed");
